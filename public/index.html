<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>Mô phỏng quầy mượn sách - Thư viện Tạ Quang Bửu</title>
    <link rel="stylesheet" href="/style.css" />
</head>

<body>
    <div class="app">
        <header class="header">
            <h1>Quầy mượn sách - Thư viện Tạ Quang Bửu</h1>
            <p>Mô phỏng khách đến xếp hàng chờ mượn / trả sách.</p>
        </header>

        <main class="main">
            <section class="controls">
                <div class="control-group">
                    <label>
                        Số quầy (server):
                        <input id="input-servers" type="number" min="1" max="6" value="2" />
                    </label>
                    <label>
                        Thời gian giữa 2 sinh viên đến (giây):
                        <input id="input-arrival" type="number" min="1" value="4" />
                    </label>
                    <label>
                        Thời gian phục vụ TB 1 sinh viên (giây):
                        <input id="input-service" type="number" min="2" value="20" />
                    </label>
                    <label>
                        Chính sách hàng đợi:
                        <select id="input-policy">
                            <option value="single_queue_fifo" selected>1 hàng chung FIFO (mặc định)</option>
                            <option value="multi_queue_shortest">Nhiều hàng theo quầy (vào hàng ngắn nhất)</option>
                        </select>
                    </label>

                    <div class="control-divider"></div>

                    <label>
                        Phân phối thời gian giữa 2 lượt đến:
                        <select id="input-arrival-dist">
                            <option value="exponential" selected>Mũ (Poisson - sát thực tế hơn)</option>
                            <option value="bernoulli_tick">Xác suất theo tick (đơn giản)</option>
                        </select>
                    </label>

                    <label>
                        Phân phối thời gian phục vụ:
                        <select id="input-service-dist">
                            <option value="uniform" selected>Đều quanh giá trị TB (0.5× đến 1.5×)</option>
                            <option value="exponential">Mũ (biến động lớn)</option>
                            <option value="deterministic">Cố định (= TB)</option>
                        </select>
                    </label>

                    <label>
                        Bật ưu tiên (priority):
                        <select id="input-priority-enabled">
                            <option value="off" selected>Tắt</option>
                            <option value="on">Bật (ưu tiên không giành quyền)</option>
                        </select>
                    </label>
                    <label>
                        Tỷ lệ SV ưu tiên (0 → 1):
                        <input id="input-priority-prob" type="number" min="0" max="1" step="0.05" value="0.10" />
                    </label>
                    <label>
                        Quy tắc ưu tiên:
                        <select id="input-priority-rule">
                            <option value="priority_then_fifo" selected>Ưu tiên trước, trong cùng nhóm FIFO</option>
                        </select>
                    </label>

                    <label>
                        Giới hạn hàng chờ tối đa:
                        <input id="input-max-queue" type="number" min="0" value="0" />
                        <span class="hint">(0 = không giới hạn)</span>
                    </label>
                    <label>
                        Ngưỡng bỏ hàng (patience, giây):
                        <input id="input-patience" type="number" min="0" value="0" />
                        <span class="hint">(0 = không bỏ hàng)</span>
                    </label>
                </div>

                <div id="input-errors" class="input-errors" aria-live="polite"></div>

                <div class="control-buttons">
                    <button id="btn-start" data-tooltip="Bắt đầu chạy mô phỏng theo tham số hiện tại">Bắt đầu mô
                        phỏng</button>
                    <button id="btn-stop" data-tooltip="Dừng mô phỏng và giữ nguyên kết quả hiện tại">Dừng</button>
                    <button id="btn-reset"
                        data-tooltip="Reset mô phỏng (xóa hàng chờ, số liệu, thời gian)">Reset</button>
                </div>

                <details class="param-help">
                    <summary>Giải thích tham số (nhấn để mở)</summary>
                    <div class="param-help-body">
                        <ul>
                            <li><strong>Số quầy</strong> n: số server phục vụ song song.</li>
                            <li><strong>Thời gian giữa 2 lượt đến (TB)</strong>: giá trị TB của khoảng cách giữa 2 SV
                                đến liên tiếp. Nếu chọn <em>Mũ</em> thì mô phỏng dòng đến Poisson (thực tế hơn).</li>
                            <li><strong>Thời gian phục vụ TB</strong>: thời gian xử lý 1 SV (trả/mượn sách) trung bình.
                                Phân phối phục vụ quyết định mức biến động quanh TB.</li>
                            <li><strong>Chính sách hàng đợi</strong>: 1 hàng chung FIFO hoặc nhiều hàng theo quầy (SV
                                vào hàng ngắn nhất).</li>
                            <li><strong>Ưu tiên</strong>: một phần SV được gán “ưu tiên” theo tỷ lệ. Quy tắc hiện tại là
                                <em>không giành quyền</em> (đang phục vụ thì không bị ngắt).</li>
                            <li><strong>Giới hạn hàng chờ</strong>: nếu &gt; 0, khi hàng đầy thì SV mới đến sẽ <em>không
                                    vào hệ thống</em> (balking).</li>
                            <li><strong>Patience</strong>: nếu &gt; 0, SV đang chờ quá ngưỡng sẽ <em>bỏ hàng</em>
                                (reneging).</li>
                        </ul>
                    </div>
                </details>

                <div class="stats-tools">
                    <div class="control-buttons">
                        <button id="btn-preset-balanced" type="button"
                            data-tooltip="Điền nhanh cấu hình tải vừa (dễ quan sát, ổn định)">Preset: Cân bằng</button>
                        <button id="btn-preset-rush" type="button"
                            data-tooltip="Điền nhanh cấu hình tải cao để thấy ùn tắc/hàng chờ tăng">Preset: Giờ cao
                            điểm</button>
                    </div>

                    <h3>Thống kê &amp; Replication</h3>
                    <div class="control-group">
                        <label>
                            Khoảng (s):
                            <input id="input-win-seconds" type="number" min="5" max="600" step="5" value="60" />
                        </label>
                        <div class="control-buttons">
                            <button id="btn-window-stats" type="button"
                                data-tooltip="Tính thống kê trong X giây gần nhất (cửa sổ thời gian)">Thống kê</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>
                            Nhãn cấu hình (tùy chọn):
                            <input id="input-snap-label" type="text" placeholder="vd: mốc 1" />
                        </label>
                        <div class="control-buttons">
                            <button id="btn-snap" type="button"
                                data-tooltip="Lưu mốc cấu hình hiện tại để so sánh/đo thống kê theo mốc">Ghi mốc cấu
                                hình</button>
                        </div>
                        <label style="flex-direction:row; align-items:center; gap:8px;">
                            <input id="chk-snap-reset" type="checkbox" checked />
                            Reset thời gian khi ghi mốc
                        </label>
                    </div>

                    <div class="control-buttons">
                        <button id="btn-toggle-dashboard" type="button"
                            data-tooltip="Bật/tắt khu vực biểu đồ để tập trung vào số liệu">Hiển thị biểu đồ</button>
                        <button id="btn-stats-by-snap" type="button"
                            data-tooltip="Tính thống kê từ mốc gần nhất đến hiện tại">Thống kê theo mốc</button>
                    </div>

                    <div id="stats-out" class="stats-out"></div>

                    <div class="control-group">
                        <label>
                            Số lần mô phỏng:
                            <input id="input-rep-count" type="number" min="5" max="200" step="1" value="30" />
                        </label>
                        <div class="control-buttons">
                            <button id="btn-run-rep" type="button"
                                data-tooltip="Chạy lặp N lần để đánh giá độ ổn định và khoảng tin cậy">Chạy nhiều
                                lần</button>
                        </div>
                    </div>

                    <div class="control-buttons">
                        <button id="btn-error-analysis" type="button"
                            data-tooltip="Xem bảng kết quả từng lần chạy + cảnh báo độ tin cậy">Phân tích lỗi thống
                            kê</button>
                        <button id="btn-export-csv" type="button"
                            data-tooltip="Tải file CSV chứa kết quả từng replication">Xuất CSV</button>
                    </div>

                    <p class="hint">Phím tắt: Space = Tạm dừng • L = Đổi policy • T = Bật/Tắt ưu tiên • R = Reset</p>
                </div>
            </section>

            <section class="stats">
                <div>Tổng sinh viên đã đến: <span id="stat-total">0</span></div>
                <div>Đang chờ trong hàng: <span id="stat-queue">0</span></div>
                <div>Đã phục vụ xong: <span id="stat-served">0</span></div>
                <div>Đang được phục vụ: <span id="stat-current">0</span></div>
                <div>Không vào hệ thống (balking): <span id="stat-balked">0</span></div>
                <div>Bỏ hàng (reneging): <span id="stat-reneged">0</span></div>
                <div>Thời gian mô phỏng (giây): <span id="stat-sim-time">0</span></div>
                <div>Thời gian chờ TB (giây): <span id="stat-wait-avg">0</span></div>
                <div>Thời gian chờ P50 (giây): <span id="stat-wait-p50">0</span></div>
                <div>Thời gian chờ P90 (giây): <span id="stat-wait-p90">0</span></div>
                <div>Độ dài hàng đợi TB: <span id="stat-queue-avg">0</span></div>
                <div>Mức sử dụng quầy TB: <span id="stat-util-avg">0%</span></div>
                <div>Tốc độ sinh viên đến λ (SV/giây): <span id="stat-lambda">0</span></div>
                <div>Thông lượng hệ thống (sinh viên rời hệ thống/giây): <span id="stat-throughput">0</span></div>
                <div>Tốc độ phục vụ TB mỗi quầy µ (SV/giây): <span id="stat-mu">0</span></div>
            </section>

            <section class="simulation">
                <div class="floor">
                    <img src="/images/floor.svg" alt="Sàn thư viện" class="floor-img" />
                    <div class="counters-row" id="counters-container"></div>
                    <div class="queue-area" id="queue-area"></div>
                    <div class="served-area" id="served-area"></div>
                </div>
            </section>
            <section class="report" id="report-section">
                <h2>Kết quả mô phỏng</h2>
                <p class="report-note">Bảng dưới đây thống kê theo từng quầy trong suốt thời gian chạy hiện tại.</p>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Quầy</th>
                            <th>Số SV đã phục vụ</th>
                            <th>Thời gian bận (giây)</th>
                            <th>Mức sử dụng (%)</th>
                        </tr>
                    </thead>
                    <tbody id="report-body"></tbody>
                </table>
                <p id="report-overall" class="report-overall"></p>
                <div id="report-explain" class="report-explain"></div>
                <p id="report-conclusion" class="report-conclusion"></p>
            </section>

            <div id="error-modal" class="modal" aria-hidden="true">
                <div class="modal-card">
                    <div class="modal-header">
                        <h3>Phân tích lỗi thống kê (Replication)</h3>
                        <button id="btn-error-close" class="btn" type="button"
                            data-tooltip="Đóng bảng phân tích">Đóng</button>
                    </div>
                    <div class="modal-body">
                        <div id="error-summary" class="hint"></div>
                        <div id="error-advice" class="hint" style="margin-top:6px;"></div>
                        <div style="margin-top:10px; overflow:auto; max-height: 360px;">
                            <table class="batch-table" id="rep-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Seed</th>
                                        <th>W (s)</th>
                                        <th>L</th>
                                        <th>ρ (%)</th>
                                        <th>Throughput</th>
                                        <th>λ</th>
                                        <th>Balking</th>
                                        <th>Reneging</th>
                                        <th>P90 (s)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <section class="dashboard" id="dashboard-section">
                <h2>Thống kê thời gian thực</h2>
                <p class="dashboard-note">Biểu đồ cập nhật theo thời gian khi mô phỏng đang chạy.</p>
                <div class="dashboard-grid">
                    <div class="chart-card">
                        <div class="chart-title">Độ dài hàng đợi theo thời gian</div>
                        <canvas id="chart-queue" width="520" height="180"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Thời gian chờ trung bình theo thời gian</div>
                        <canvas id="chart-wait" width="520" height="180"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Mức sử dụng quầy trung bình theo thời gian</div>
                        <canvas id="chart-util" width="520" height="180"></canvas>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>Môn: Lập trình mô phỏng - Mô phỏng quầy mượn sách Thư viện Tạ Quang Bửu.</p>
        </footer>
    </div>

    <!-- INPUT / ENGINE / OUTPUT -->
    <script src="/js/engine.js"></script>
    <script src="/js/output.js"></script>
    <script src="/js/dashboard.js"></script>
    <script src="/js/input.js"></script>
    <script src="/js/app.js"></script>
</body>

</html>